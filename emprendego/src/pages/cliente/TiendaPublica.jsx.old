import { useState, useEffect, useMemo, useCallback, memo } from 'react'
import { useParams } from 'react-router-dom'
import { supabase } from '../../lib/supabaseClient'
import { generateThemeFromStore, HEADER_STYLES, CARD_STYLES, BUTTON_STYLES } from '../../data/templates'
import { getRemainingTime } from '../../lib/subscription'
import {
  isProductWithVariants,
  getActiveVariants,
  getMinVariantPrice,
  getMaxVariantPrice,
  hasPriceRange,
  getProductAvailability,
  getVariantAvailability,
  findMatchingVariant,
  generateCartItemId,
  getAvailableStock,
} from '../../lib/variants'

// L칤mites del plan gratis (fallback)
const FREE_PLAN_LIMITS = { maxProducts: 10, maxCategories: 3 }

/**
 * Helper para aplicar l칤mite a una query de Supabase solo si es v치lido.
 * Si limit es null, undefined, -1 o <= 0, NO aplica .limit() (ilimitado).
 * Si limit es un entero positivo, aplica .limit(n).
 */
const applyLimit = (query, limit) => {
  if (limit === null || limit === undefined) return query
  const n = Number(limit)
  if (n === -1 || !Number.isFinite(n) || n <= 0) return query
  return query.limit(n)
}
import { 
  ShoppingBag, 
  Search, 
  X, 
  Plus, 
  Minus, 
  Trash2, 
  MessageCircle,
  Store,
  ChevronLeft,
  ChevronRight,
  AlertCircle,
  Package,
  MapPin,
  Clock,
  Phone,
  Instagram,
  Facebook,
  CreditCard,
  Truck,
  Star,
  Sparkles,
  Heart,
  Share2,
  Check,
  ShieldCheck,
  Tag,
  Rocket,
} from 'lucide-react'

// ============================================
// TIENDA P칔BLICA - Vista del cliente (Redise침o Premium)
// ============================================

// ============================================
// UTILIDADES DE TRACKING LOCAL (Para recomendaciones)
// ============================================

const STORAGE_KEY_PREFIX = 'eg_store_activity_'
const MAX_TRACKED_ITEMS = 30

/**
 * Obtiene la actividad del usuario para una tienda espec칤fica
 */
const getStoreActivity = (storeId) => {
  if (!storeId) return null
  try {
    const data = localStorage.getItem(`${STORAGE_KEY_PREFIX}${storeId}`)
    return data ? JSON.parse(data) : {
      viewedProducts: [],
      viewedCategories: [],
      addedToCart: [],
      searchTerms: [],
    }
  } catch {
    return { viewedProducts: [], viewedCategories: [], addedToCart: [], searchTerms: [] }
  }
}

/**
 * Guarda la actividad del usuario
 */
const saveStoreActivity = (storeId, activity) => {
  if (!storeId) return
  try {
    // Limitar arrays para no saturar storage
    const trimmed = {
      viewedProducts: activity.viewedProducts.slice(-MAX_TRACKED_ITEMS),
      viewedCategories: activity.viewedCategories.slice(-MAX_TRACKED_ITEMS),
      addedToCart: activity.addedToCart.slice(-MAX_TRACKED_ITEMS),
      searchTerms: activity.searchTerms.slice(-10),
    }
    localStorage.setItem(`${STORAGE_KEY_PREFIX}${storeId}`, JSON.stringify(trimmed))
  } catch {
    // Storage lleno, ignorar
  }
}

/**
 * Registra un evento de vista de producto
 */
const trackProductView = (storeId, productId, categoryId) => {
  const activity = getStoreActivity(storeId)
  if (!activity) return

  // Agregar producto visto (sin duplicar consecutivos)
  if (activity.viewedProducts[activity.viewedProducts.length - 1] !== productId) {
    activity.viewedProducts.push(productId)
  }
  
  // Agregar categor칤a vista
  if (categoryId && activity.viewedCategories[activity.viewedCategories.length - 1] !== categoryId) {
    activity.viewedCategories.push(categoryId)
  }
  
  saveStoreActivity(storeId, activity)
}

/**
 * Registra un evento de agregar al carrito
 */
const trackAddToCart = (storeId, productId, categoryId = null) => {
  const activity = getStoreActivity(storeId)
  if (!activity) return
  
  if (!activity.addedToCart.includes(productId)) {
    activity.addedToCart.push(productId)
  }
  
  // Trackear categor칤a del producto agregado (m치s peso)
  if (categoryId) {
    activity.cartCategories = activity.cartCategories || []
    activity.cartCategories.push(categoryId)
    // Mantener solo 칰ltimas 10
    if (activity.cartCategories.length > 10) {
      activity.cartCategories = activity.cartCategories.slice(-10)
    }
  }
  
  saveStoreActivity(storeId, activity)
}

/**
 * 游 ALGORITMO INTELIGENTE DE RECOMENDACIONES
 * Sistema de scoring multicapa para "Te puede interesar"
 * 
 * Se침ales utilizadas:
 * 1. Coincidencia con b칰squeda actual (peso ALTO)
 * 2. Historial de interacci칩n en sesi칩n (peso MEDIO)
 * 3. Popularidad del producto (peso MEDIO)
 * 4. Diversidad controlada (peso BAJO)
 * 5. Exclusiones inteligentes
 */
const generateRecommendations = (storeId, products, context = {}) => {
  const {
    currentProductId = null,
    searchQuery = '',
    selectedCategory = 'all',
    categories = [],
  } = context

  const activity = getStoreActivity(storeId)
  if (!activity || products.length === 0) return []

  // =========================================
  // 1. PREPARAR DATOS DE CONTEXTO
  // =========================================
  
  // Frecuencia de categor칤as vistas en sesi칩n
  const viewedCategoryFreq = {}
  activity.viewedCategories.forEach(catId => {
    viewedCategoryFreq[catId] = (viewedCategoryFreq[catId] || 0) + 1
  })
  
  // Frecuencia de categor칤as en carrito (m치s peso)
  const cartCategoryFreq = {}
  ;(activity.cartCategories || []).forEach(catId => {
    cartCategoryFreq[catId] = (cartCategoryFreq[catId] || 0) + 1
  })

  // Obtener nombre de categor칤a activa para matching de texto
  const activeCategoryName = selectedCategory !== 'all' 
    ? categories.find(c => c.id === selectedCategory)?.name?.toLowerCase() || ''
    : ''

  // Normalizar b칰squeda
  const searchTerms = searchQuery.toLowerCase().trim().split(/\s+/).filter(Boolean)

  // =========================================
  // 2. CALCULAR SCORE PARA CADA PRODUCTO
  // =========================================
  
  const scored = products.map(product => {
    let score = 0
    const reasons = [] // Para debug

    // -----------------------------------------
    // 2.1 COINCIDENCIA CON B칔SQUEDA (Peso ALTO)
    // -----------------------------------------
    if (searchTerms.length > 0) {
      const productName = (product.name || '').toLowerCase()
      const productDesc = (product.description || '').toLowerCase()
      
      searchTerms.forEach(term => {
        // Coincidencia en nombre (+30 por t칠rmino)
        if (productName.includes(term)) {
          score += 30
          reasons.push(`name:${term}`)
        }
        // Coincidencia en descripci칩n (+15 por t칠rmino)
        else if (productDesc.includes(term)) {
          score += 15
          reasons.push(`desc:${term}`)
        }
      })
    }

    // Misma categor칤a que filtro activo (+50)
    if (selectedCategory !== 'all' && product.category_id === selectedCategory) {
      score += 50
      reasons.push('sameCat')
    }

    // -----------------------------------------
    // 2.2 HISTORIAL DE SESI칍N (Peso MEDIO)
    // -----------------------------------------
    
    // Categor칤a vista en sesi칩n (+3 por frecuencia)
    if (product.category_id && viewedCategoryFreq[product.category_id]) {
      score += viewedCategoryFreq[product.category_id] * 3
      reasons.push(`viewedCat:${viewedCategoryFreq[product.category_id]}`)
    }
    
    // Categor칤a en carrito (+8 por frecuencia, m치s peso)
    if (product.category_id && cartCategoryFreq[product.category_id]) {
      score += cartCategoryFreq[product.category_id] * 8
      reasons.push(`cartCat:${cartCategoryFreq[product.category_id]}`)
    }

    // -----------------------------------------
    // 2.3 POPULARIDAD INTERNA (Peso MEDIO)
    // -----------------------------------------
    
    // Producto destacado (+10)
    if (product.is_featured) {
      score += 10
      reasons.push('featured')
    }
    
    // Producto con descuento (+5) - atrae atenci칩n
    if (product.compare_price && product.compare_price > product.price) {
      score += 5
      reasons.push('discount')
    }
    
    // Producto con buenas ventas (si existe el campo)
    if (product.total_sales > 0) {
      score += Math.min(product.total_sales, 20) // Cap en 20 puntos
      reasons.push(`sales:${product.total_sales}`)
    }

    // -----------------------------------------
    // 2.4 PENALIZACIONES (Exclusiones suaves)
    // -----------------------------------------
    
    // Visto recientemente (-5, menos penalizaci칩n que antes)
    const recentViewed = activity.viewedProducts.slice(-5)
    if (recentViewed.includes(product.id)) {
      score -= 5
      reasons.push('recentlyViewed')
    }
    
    // Ya est치 en carrito (-30, no mostrar lo que ya tiene)
    if (activity.addedToCart.includes(product.id)) {
      score -= 30
      reasons.push('inCart')
    }
    
    // Excluir producto actual (modal abierto)
    if (product.id === currentProductId) {
      score = -1000
      reasons.push('currentProduct')
    }
    
    // Excluir productos sin stock
    if (product.track_inventory && product.stock_quantity === 0) {
      score = -1000
      reasons.push('outOfStock')
    }
    
    // Excluir productos inactivos
    if (product.is_active === false) {
      score = -1000
      reasons.push('inactive')
    }

    return { ...product, _score: score, _reasons: reasons }
  })

  // =========================================
  // 3. ORDENAR Y APLICAR DIVERSIDAD
  // =========================================
  
  // Filtrar excluidos y ordenar por score
  const candidates = scored
    .filter(p => p._score > -100)
    .sort((a, b) => b._score - a._score)

  // Aplicar diversidad: m치ximo 2 productos de la misma categor칤a
  const final = []
  const categoryCount = {}
  
  for (const product of candidates) {
    if (final.length >= 4) break // M치ximo 4 productos
    
    const catId = product.category_id || 'uncategorized'
    const currentCount = categoryCount[catId] || 0
    
    // Permitir m치ximo 2 de la misma categor칤a para diversidad
    if (currentCount < 2) {
      final.push(product)
      categoryCount[catId] = currentCount + 1
    }
  }

  // =========================================
  // 4. FALLBACK SI NO HAY SUFICIENTES
  // =========================================
  
  // Si tenemos menos de 3, completar con destacados/nuevos
  if (final.length < 3) {
    const usedIds = new Set(final.map(p => p.id))
    
    // Agregar destacados no usados
    const fallbacks = products
      .filter(p => !usedIds.has(p.id) && p._score > -100)
      .filter(p => p.is_featured || !p.compare_price) // Destacados o precio normal
      .slice(0, 4 - final.length)
    
    final.push(...fallbacks)
  }

  return final.slice(0, 4) // Garantizar m치ximo 4
}

export default function TiendaPublica({ 
  isPreview = false, 
  previewStore = null,
  previewProducts = [],
  previewCategories = [] 
}) {
  const { slug } = useParams()
  
  // Estados principales
  const [store, setStore] = useState(null)
  const [products, setProducts] = useState([])
  const [categories, setCategories] = useState([])
  const [loading, setLoading] = useState(!isPreview) // No loading si es preview
  const [error, setError] = useState(null)
  
  // Estados de UI
  const [searchQuery, setSearchQuery] = useState('')
  const [selectedCategory, setSelectedCategory] = useState('all')
  const [selectedProduct, setSelectedProduct] = useState(null)
  const [cart, setCart] = useState([])
  const [isCartOpen, setIsCartOpen] = useState(false)
  const [imageIndex, setImageIndex] = useState(0)

  // En modo preview, usar datos proporcionados directamente
  useEffect(() => {
    if (isPreview && previewStore) {
      setStore(previewStore)
      setProducts(previewProducts || [])
      setCategories(previewCategories || [])
      setLoading(false)
    }
  }, [isPreview, previewStore, previewProducts, previewCategories])

  // Cargar datos de la tienda (solo si NO es preview)
  useEffect(() => {
    if (isPreview) return // No cargar datos en modo preview

    const fetchStoreData = async () => {
      try {
        setLoading(true)
        setError(null)

        // Obtener tienda por slug
        const { data: storeData, error: storeError } = await supabase
          .from('stores')
          .select('*')
          .eq('slug', slug)
          .eq('is_active', true)
          .single()

        if (storeError || !storeData) {
          setError('not_found')
          return
        }

        setStore(storeData)

        // ========================================
        // OBTENER L칈MITES DEL PLAN EFECTIVO
        // ========================================
        let effectiveLimits = FREE_PLAN_LIMITS
        
        // Verificar si la suscripci칩n est치 expirada
        const subscriptionStatus = getRemainingTime(storeData.subscription_end_at)
        const isSubscriptionExpired = subscriptionStatus.hasSubscription && subscriptionStatus.isExpired
        
        // Si no expir칩, obtener l칤mites del plan actual
        if (!isSubscriptionExpired && storeData.plan) {
          const { data: planData } = await supabase
            .from('plans')
            .select('max_products, max_categories')
            .eq('slug', storeData.plan)
            .single()
          
          if (planData) {
            effectiveLimits = {
              maxProducts: planData.max_products ?? FREE_PLAN_LIMITS.maxProducts,
              maxCategories: planData.max_categories ?? FREE_PLAN_LIMITS.maxCategories,
            }
          }
        }

        // Obtener categor칤as activas (limitadas por plan si aplica)
        let categoriesQuery = supabase
          .from('categories')
          .select('*')
          .eq('store_id', storeData.id)
          .eq('is_active', true)
          .order('sort_order', { ascending: true })
        
        categoriesQuery = applyLimit(categoriesQuery, effectiveLimits.maxCategories)
        const { data: categoriesData, error: categoriesError } = await categoriesQuery
        
        if (categoriesError) {
          console.error('Error fetching categories:', categoriesError)
        }

        setCategories(categoriesData || [])

        // Obtener productos activos (limitados por plan si aplica)
        let productsQuery = supabase
          .from('products')
          .select('*')
          .eq('store_id', storeData.id)
          .eq('is_active', true)
          .order('sort_order', { ascending: true })
        
        productsQuery = applyLimit(productsQuery, effectiveLimits.maxProducts)
        const { data: productsData, error: productsError } = await productsQuery
        
        if (productsError) {
          console.error('Error fetching products:', productsError)
        }

        setProducts(productsData || [])

        // Incrementar vistas (solo en modo real, no preview)
        await supabase
          .from('stores')
          .update({ total_views: (storeData.total_views || 0) + 1 })
          .eq('id', storeData.id)

      } catch (err) {
        console.error('Error loading store:', err)
        setError('error')
      } finally {
        setLoading(false)
      }
    }

    if (slug) {
      fetchStoreData()
    }
  }, [slug, isPreview])

  // Filtrar productos
  const filteredProducts = useMemo(() => {
    return products.filter(product => {
      const matchesSearch = !searchQuery || 
        product.name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        product.description?.toLowerCase().includes(searchQuery.toLowerCase())
      
      const matchesCategory = selectedCategory === 'all' || 
        product.category_id === selectedCategory

      return matchesSearch && matchesCategory
    })
  }, [products, searchQuery, selectedCategory])

  // Generar recomendaciones inteligentes (solo para planes de pago)
  const recommendations = useMemo(() => {
    if (!store?.id || store?.plan === 'gratis' || isPreview) return []
    return generateRecommendations(store.id, products, {
      currentProductId: selectedProduct?.id,
      searchQuery,
      selectedCategory,
      categories,
    })
  }, [store?.id, store?.plan, products, selectedProduct?.id, isPreview, searchQuery, selectedCategory, categories])

  // Handler para ver producto (con tracking)
  const handleViewProduct = useCallback((product) => {
    if (!isPreview && store?.id) {
      trackProductView(store.id, product.id, product.category_id)
    }
    setSelectedProduct(product)
    setImageIndex(0)
  }, [isPreview, store?.id])

  // Funciones del carrito - ACTUALIZADAS PARA VARIANTES
  const addToCart = useCallback((product, variant = null) => {
    // Track para recomendaciones (incluye category_id para scoring)
    if (!isPreview && store?.id) {
      trackAddToCart(store.id, product.id, product.category_id)
    }
    
    // Generar ID 칰nico del item en carrito
    const cartItemId = generateCartItemId(product.id, variant?.id)
    
    // Calcular precio y datos de la variante
    const itemPrice = variant?.price ?? product.price
    const itemImage = variant?.image_url ?? product.main_image_url
    
    setCart(prev => {
      const existing = prev.find(item => item.cartItemId === cartItemId)
      if (existing) {
        return prev.map(item => 
          item.cartItemId === cartItemId 
            ? { ...item, quantity: item.quantity + 1 }
            : item
        )
      }
      return [...prev, {
        cartItemId,
        id: product.id, // Mantener para compatibilidad
        product_id: product.id,
        variant_id: variant?.id || null,
        name: product.name,
        variant_title: variant?.title || null,
        selected_options: variant?.options || null,
        price: itemPrice,
        main_image_url: itemImage,
        quantity: 1,
        track_inventory: product.track_inventory,
        stock_quantity: variant?.stock_quantity ?? product.stock_quantity,
      }]
    })
  }, [isPreview, store?.id])

  const updateQuantity = useCallback((cartItemId, delta) => {
    setCart(prev => {
      return prev.map(item => {
        if (item.cartItemId === cartItemId) {
          const newQty = item.quantity + delta
          return newQty > 0 ? { ...item, quantity: newQty } : null
        }
        return item
      }).filter(Boolean)
    })
  }, [])

  const removeFromCart = useCallback((cartItemId) => {
    setCart(prev => prev.filter(item => item.cartItemId !== cartItemId))
  }, [])

  const cartTotal = useMemo(() => {
    return cart.reduce((sum, item) => sum + (item.price * item.quantity), 0)
  }, [cart])

  const cartCount = useMemo(() => {
    return cart.reduce((sum, item) => sum + item.quantity, 0)
  }, [cart])

  // Formatear precio
  const formatPrice = (price) => {
    return new Intl.NumberFormat('es-CO', {
      style: 'currency',
      currency: store?.currency || 'COP',
      minimumFractionDigits: 0,
      maximumFractionDigits: 0
    }).format(price)
  }

  // Enviar pedido por WhatsApp (deshabilitado en preview) - CON VARIANTES
  const sendWhatsAppOrder = () => {
    if (isPreview) return // No permitir en modo preview
    if (!store?.whatsapp || cart.length === 0) return

    // Sanitizar n칰mero: solo d칤gitos, sin espacios ni caracteres especiales
    const phone = store.whatsapp.replace(/\D/g, '')
    
    // Construir mensaje con emojis usando c칩digos Unicode expl칤citos
    const lines = [
      '\u{1F6D2} *Nuevo Pedido - ' + store.name + '*',
      '',
      '\u{1F4E6} *Productos:*',
      ...cart.map((item, index) => {
        // Incluir variante si existe
        const variantInfo = item.variant_title ? ` (${item.variant_title})` : ''
        return `${index + 1}. ${item.name}${variantInfo} x${item.quantity} - ${formatPrice(item.price * item.quantity)}`
      }),
      '',
      '\u{1F4B0} *Total: ' + formatPrice(cartTotal) + '*',
      '',
      '\u{00A1}Gracias por tu pedido! \u{1F64F}'
    ]
    
    const message = lines.join('\n')

    // Construir URL con encoding correcto
    const encodedMessage = encodeURIComponent(message)
    const whatsappUrl = `https://wa.me/${phone}?text=${encodedMessage}`
    
    // Abrir en nueva ventana
    window.open(whatsappUrl, '_blank', 'noopener,noreferrer')
  }

  // Colores de la tienda (con fallbacks)
  const primaryColor = store?.primary_color || '#2563eb'
  const secondaryColor = store?.secondary_color || '#7c3aed'

  // Theme basado en plantilla (si existe)
  const theme = useMemo(() => {
    if (!store) return null
    return generateThemeFromStore(store)
  }, [store])

  // ============================================
  // ESTADOS DE CARGA Y ERROR
  // ============================================

  if (loading) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="text-center">
          <div 
            className="w-12 h-12 border-3 rounded-full animate-spin mx-auto mb-4"
            style={{ 
              borderTopColor: 'transparent',
              borderRightColor: primaryColor,
              borderBottomColor: primaryColor,
              borderLeftColor: primaryColor,
            }}
          />
          <p className="text-gray-500">Cargando tienda...</p>
        </div>
      </div>
    )
  }

  if (error === 'not_found') {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-50 to-gray-100 p-4">
        <div className="text-center max-w-md">
          <div className="w-24 h-24 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-6">
            <Store className="w-12 h-12 text-gray-400" />
          </div>
          <h1 className="text-3xl font-bold text-gray-900 mb-3">Tienda no encontrada</h1>
          <p className="text-gray-500 mb-6">
            La tienda que buscas no existe o ha sido desactivada.
          </p>
          <a 
            href="/"
            className="inline-flex items-center gap-2 px-6 py-3 bg-gray-900 text-white rounded-xl hover:bg-gray-800 transition-colors"
          >
            Volver al inicio
          </a>
        </div>
      </div>
    )
  }

  if (error) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
        <div className="text-center max-w-md">
          <AlertCircle className="w-16 h-16 text-red-500 mx-auto mb-4" />
          <h1 className="text-2xl font-bold text-gray-900 mb-2">Error al cargar</h1>
          <p className="text-gray-500 mb-6">
            Hubo un problema al cargar la tienda. Intenta nuevamente.
          </p>
          <button 
            onClick={() => window.location.reload()}
            className="px-6 py-3 bg-gray-900 text-white rounded-xl hover:bg-gray-800 transition-colors"
          >
            Reintentar
          </button>
        </div>
      </div>
    )
  }

  // ============================================
  // RENDER PRINCIPAL
  // ============================================

  // Guardia: si no hay store, mostrar loading (para modo preview mientras carga)
  if (!store) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-gray-50">
        <div className="text-center">
          <div 
            className="w-12 h-12 border-3 rounded-full animate-spin mx-auto mb-4"
            style={{ 
              borderTopColor: 'transparent',
              borderRightColor: '#2563eb',
              borderBottomColor: '#2563eb',
              borderLeftColor: '#2563eb',
            }}
          />
          <p className="text-gray-500">Cargando tienda...</p>
        </div>
      </div>
    )
  }

  return (
    <div 
      className="min-h-screen"
      style={{ 
        backgroundColor: theme?.background || '#f9fafb',
        fontFamily: theme?.fontFamily || 'Inter, system-ui, sans-serif',
        '--eg-primary': theme?.primary || primaryColor,
        '--eg-secondary': theme?.secondary || secondaryColor,
        '--eg-accent': theme?.accent || primaryColor,
        '--eg-bg': theme?.background || '#f9fafb',
        '--eg-surface': theme?.surface || '#ffffff',
      }}
    >
      {/* ============================================
          HEADER PREMIUM
          ============================================ */}
      <header 
        className={`sticky top-0 z-40 transition-all ${
          theme?.headerStyle === 'glass' 
            ? 'backdrop-blur-xl bg-white/80 border-b border-white/30 shadow-sm' 
            : theme?.headerStyle === 'minimal'
            ? 'bg-white/95 backdrop-blur-sm border-b border-gray-100'
            : 'bg-white border-b border-gray-100 shadow-sm'
        }`}
      >
        <div className="max-w-6xl mx-auto px-3 sm:px-4 h-14 sm:h-16 flex items-center justify-between gap-2 sm:gap-4">
          {/* Logo y nombre - Premium */}
          <div className="flex items-center gap-2 sm:gap-3 min-w-0 flex-1">
            {store.logo_url ? (
              <div className="relative shrink-0">
                <img 
                  src={store.logo_url} 
                  alt={store.name}
                  className="w-9 h-9 sm:w-11 sm:h-11 rounded-xl object-cover ring-2 ring-white shadow-md"
                />
              </div>
            ) : (
              <div 
                className="w-9 h-9 sm:w-11 sm:h-11 rounded-xl flex items-center justify-center text-white font-bold text-base sm:text-lg shadow-lg ring-2 ring-white/50 shrink-0"
                style={{ background: `linear-gradient(135deg, ${primaryColor}, ${secondaryColor})` }}
              >
                {store.name?.charAt(0)?.toUpperCase()}
              </div>
            )}
            <div className="min-w-0 flex-1">
              <div className="flex items-center gap-1.5 min-w-0">
                <span className="inline-flex items-center gap-1.5 min-w-0 max-w-full sm:max-w-none px-2 py-0.5 sm:px-0 sm:py-0 rounded-lg bg-gray-50 sm:bg-transparent border border-gray-200 sm:border-0">
                  <h1 className="font-bold text-gray-900 leading-tight truncate text-sm sm:text-base">
                    {store.name}
                  </h1>
                  {store.plan !== 'gratis' && (
                    <ShieldCheck className="w-3.5 h-3.5 sm:w-4 sm:h-4 text-blue-500 flex-shrink-0" title="Tienda verificada" />
                  )}
                </span>
              </div>
              {store.city && (
                <p className="text-xs text-gray-500 flex items-center gap-1 mt-0.5 truncate">
                  <MapPin className="w-3 h-3 shrink-0" />
                  <span className="truncate">{store.city}</span>
                </p>
              )}
            </div>
          </div>

          {/* Acciones del header */}
          <div className="flex items-center gap-1 sm:gap-2 shrink-0">
            {/* Compartir (solo desktop) */}
            <button
              onClick={() => {
                if (navigator.share) {
                  navigator.share({ title: store.name, url: window.location.href })
                } else {
                  navigator.clipboard.writeText(window.location.href)
                }
              }}
              className="hidden sm:flex p-2.5 rounded-xl hover:bg-gray-100 transition-colors"
              title="Compartir tienda"
            >
              <Share2 className="w-5 h-5 text-gray-500" />
            </button>
            
            {/* Carrito - Premium */}
            <button
              onClick={() => setIsCartOpen(true)}
              className="relative p-2 sm:p-2.5 rounded-xl hover:bg-gray-100 transition-colors group"
            >
              <ShoppingBag className="w-5 h-5 sm:w-6 sm:h-6 text-gray-700 group-hover:scale-105 transition-transform" />
              {cartCount > 0 && (
                <span 
                  className="absolute -top-0.5 -right-0.5 sm:-top-1 sm:-right-1 min-w-[18px] sm:min-w-[20px] h-[18px] sm:h-5 px-1 text-[10px] sm:text-xs font-bold text-white rounded-full flex items-center justify-center shadow-lg"
                  style={{ backgroundColor: primaryColor }}
                >
                  {cartCount > 99 ? '99+' : cartCount}
                </span>
              )}
            </button>
          </div>
        </div>
      </header>

      {/* ============================================
          HERO / BANNER PREMIUM
          ============================================ */}
      {store.banner_url ? (
        <div className="relative h-44 sm:h-56 md:h-72 overflow-hidden">
          <img 
            src={store.banner_url} 
            alt="Banner"
            className="w-full h-full object-cover"
          />
          {/* Overlay con gradiente elegante */}
          <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent" />
          
          {/* Info sobre el banner (solo desktop) */}
          <div className="absolute bottom-0 left-0 right-0 p-6 hidden md:block">
            <div className="max-w-6xl mx-auto">
              {store.description && (
                <p className="text-white/90 text-sm max-w-xl line-clamp-2">
                  {store.description}
                </p>
              )}
            </div>
          </div>
        </div>
      ) : (
        /* Hero sin banner - Gradiente elegante */
        <div 
          className="relative h-36 sm:h-44 md:h-52 overflow-hidden"
          style={{ 
            background: `linear-gradient(135deg, ${primaryColor}15 0%, ${secondaryColor}20 50%, ${primaryColor}10 100%)` 
          }}
        >
          {/* Patr칩n decorativo sutil */}
          <div 
            className="absolute inset-0 opacity-30"
            style={{
              backgroundImage: `radial-gradient(circle at 20% 50%, ${primaryColor}20 0%, transparent 50%), radial-gradient(circle at 80% 50%, ${secondaryColor}20 0%, transparent 50%)`
            }}
          />
          
          {/* Contenido del hero */}
          <div className="relative h-full max-w-6xl mx-auto px-4 flex flex-col justify-center">
            {store.description && (
              <p className="text-gray-600 text-sm md:text-base max-w-xl">
                {store.description}
              </p>
            )}
          </div>
        </div>
      )}

      {/* ============================================
          CONTENIDO PRINCIPAL
          ============================================ */}
      <main className="max-w-6xl mx-auto px-4 py-6">
        
        {/* Mensaje de bienvenida - Premium */}
        {store.welcome_message && (
          <div 
            className="mb-6 p-4 sm:p-5 rounded-2xl text-white relative overflow-hidden"
            style={{ background: `linear-gradient(135deg, ${primaryColor}, ${secondaryColor})` }}
          >
            {/* Decoraci칩n */}
            <div className="absolute top-0 right-0 w-32 h-32 opacity-10">
              <Sparkles className="w-full h-full" />
            </div>
            <p className="relative text-center font-medium text-sm sm:text-base">
              {store.welcome_message}
            </p>
          </div>
        )}

        {/* ============================================
            BARRA DE B칔SQUEDA Y FILTROS
            ============================================ */}
        <div className="space-y-4 mb-6">
          {/* B칰squeda premium */}
          <div className="relative">
            <Search className="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
            <input
              type="text"
              placeholder="쯈u칠 est치s buscando?"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="w-full pl-12 pr-4 h-12 bg-white border border-gray-200 rounded-2xl focus:outline-none focus:ring-2 focus:border-transparent shadow-sm hover:shadow-md transition-shadow"
              style={{ '--tw-ring-color': primaryColor }}
            />
            {searchQuery && (
              <button
                onClick={() => setSearchQuery('')}
                className="absolute right-3 top-1/2 -translate-y-1/2 p-1.5 bg-gray-100 hover:bg-gray-200 rounded-full transition-colors"
              >
                <X className="w-4 h-4 text-gray-500" />
              </button>
            )}
          </div>

          {/* Filtro por categor칤as - Premium pills */}
          {categories.length > 0 && (
            <div className="flex items-center gap-3">
              <div className="flex gap-2 overflow-x-auto pb-1 scrollbar-hide flex-1">
                <button
                  onClick={() => setSelectedCategory('all')}
                  className={`flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-all ${
                    selectedCategory === 'all'
                      ? 'text-white shadow-lg scale-105'
                      : 'bg-white text-gray-600 hover:bg-gray-50 border border-gray-200 hover:border-gray-300'
                  }`}
                  style={selectedCategory === 'all' ? { 
                    backgroundColor: primaryColor,
                    boxShadow: `0 4px 14px ${primaryColor}40`
                  } : {}}
                >
                  Todos
                </button>
                {categories.map(category => (
                  <button
                    key={category.id}
                    onClick={() => setSelectedCategory(category.id)}
                    className={`flex-shrink-0 px-4 py-2 rounded-full text-sm font-medium transition-all ${
                      selectedCategory === category.id
                        ? 'text-white shadow-lg scale-105'
                        : 'bg-white text-gray-600 hover:bg-gray-50 border border-gray-200 hover:border-gray-300'
                    }`}
                    style={selectedCategory === category.id ? { 
                      backgroundColor: primaryColor,
                      boxShadow: `0 4px 14px ${primaryColor}40`
                    } : {}}
                  >
                    {category.name}
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* Contador de resultados */}
          <div className="flex items-center justify-between text-sm">
            <p className="text-gray-500">
              {filteredProducts.length === 0 
                ? 'Sin resultados'
                : filteredProducts.length === 1 
                  ? '1 producto' 
                  : `${filteredProducts.length} productos`
              }
              {searchQuery && <span className="text-gray-400"> para "{searchQuery}"</span>}
            </p>
          </div>
        </div>

        {/* ============================================
            GRID DE PRODUCTOS
            ============================================ */}
        {filteredProducts.length === 0 ? (
          <div className="text-center py-16 bg-white rounded-3xl border border-gray-100">
            <div className="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <Package className="w-10 h-10 text-gray-300" />
            </div>
            <h3 className="text-lg font-semibold text-gray-900 mb-2">
              {searchQuery ? 'Sin resultados' : 'No hay productos'}
            </h3>
            <p className="text-gray-500 max-w-sm mx-auto">
              {searchQuery 
                ? 'Intenta con otra b칰squeda o explora otras categor칤as' 
                : 'Esta tienda a칰n no tiene productos disponibles'}
            </p>
            {searchQuery && (
              <button
                onClick={() => setSearchQuery('')}
                className="mt-4 px-4 py-2 text-sm font-medium rounded-xl hover:bg-gray-100 transition-colors"
                style={{ color: primaryColor }}
              >
                Limpiar b칰squeda
              </button>
            )}
          </div>
        ) : (
          <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-4 lg:gap-5">
            {filteredProducts.map(product => (
              <ProductCard
                key={product.id}
                product={product}
                primaryColor={primaryColor}
                formatPrice={formatPrice}
                onView={() => handleViewProduct(product)}
                onAddToCart={(p, v) => addToCart(p || product, v)}
              />
            ))}
          </div>
        )}

        {/* ============================================
            SECCI칍N "TE PUEDE INTERESAR" (Solo planes de pago)
            ============================================ */}
        {recommendations.length > 0 && store?.plan !== 'gratis' && (
          <RecommendedSection
            products={recommendations}
            primaryColor={primaryColor}
            formatPrice={formatPrice}
            onView={handleViewProduct}
            onAddToCart={addToCart}
          />
        )}

        {/* ============================================
            FOOTER DE TIENDA - Informaci칩n adicional
            ============================================ */}
        <StoreFooter store={store} primaryColor={primaryColor} />
      </main>

      {/* Bot칩n flotante de carrito - Premium */}
      {cart.length > 0 && !isCartOpen && (
        <div className="fixed bottom-6 left-1/2 -translate-x-1/2 z-50">
          <button
            onClick={() => setIsCartOpen(true)}
            className="flex items-center gap-3 px-6 py-4 text-white rounded-2xl shadow-2xl hover:scale-105 transition-transform backdrop-blur-sm"
            style={{ 
              backgroundColor: primaryColor,
              boxShadow: `0 10px 40px ${primaryColor}50`
            }}
          >
            <ShoppingBag className="w-5 h-5" />
            <span className="font-semibold">Ver carrito ({cartCount})</span>
            <span className="font-bold">{formatPrice(cartTotal)}</span>
          </button>
        </div>
      )}

      {/* Modal de producto - CON SOPORTE VARIANTES */}
      {selectedProduct && (
        <ProductModal
          product={selectedProduct}
          primaryColor={primaryColor}
          secondaryColor={secondaryColor}
          formatPrice={formatPrice}
          imageIndex={imageIndex}
          setImageIndex={setImageIndex}
          onClose={() => setSelectedProduct(null)}
          onAddToCart={addToCart}
        />
      )}

      {/* Drawer del carrito */}
      {isCartOpen && (
        <CartDrawer
          cart={cart}
          store={store}
          primaryColor={primaryColor}
          formatPrice={formatPrice}
          cartTotal={cartTotal}
          updateQuantity={updateQuantity}
          removeFromCart={removeFromCart}
          onClose={() => setIsCartOpen(false)}
          onCheckout={sendWhatsAppOrder}
        />
      )}
    </div>
  )
}

// ============================================
// COMPONENTES INTERNOS
// ============================================

/**
 * ProductCard - Tarjeta de producto premium - CON SOPORTE VARIANTES
 */
const ProductCard = memo(function ProductCard({ product, primaryColor, formatPrice, onView, onAddToCart }) {
  const [added, setAdded] = useState(false)
  
  // Detectar si tiene variantes
  const hasVariants = isProductWithVariants(product)
  const activeVariants = hasVariants ? getActiveVariants(product) : []
  
  // Calcular precios para variantes
  const displayPrice = hasVariants ? getMinVariantPrice(product) : product.price
  const showPriceRange = hasVariants && hasPriceRange(product)
  
  // Descuento (solo aplica a productos sin variantes)
  const hasDiscount = !hasVariants && product.compare_price && product.compare_price > product.price
  
  // Stock
  const isLowStock = product.track_inventory && !hasVariants && product.stock_quantity > 0 && product.stock_quantity <= 5
  const isOutOfStock = !getProductAvailability(product)

  const handleAdd = (e) => {
    e.stopPropagation()
    if (isOutOfStock) return
    
    // Si tiene variantes, abrir modal para elegir
    if (hasVariants && activeVariants.length > 1) {
      onView()
      return
    }
    
    // Si tiene 1 sola variante, agregar esa directamente
    if (hasVariants && activeVariants.length === 1) {
      onAddToCart(product, activeVariants[0])
    } else {
      // Producto sin variantes
      onAddToCart(product, null)
    }
    
    setAdded(true)
    setTimeout(() => setAdded(false), 1500)
  }

  return (
    <div className="bg-white rounded-2xl overflow-hidden border border-gray-100 hover:shadow-xl hover:border-gray-200 transition-all duration-300 group">
      {/* Imagen - Contenedor fijo con aspect ratio */}
      <div 
        className="relative w-full overflow-hidden bg-gray-50 cursor-pointer"
        onClick={onView}
      >
        {/* Aspect ratio container - cuadrado en m칩vil, 4:3 en desktop */}
        <div className="relative w-full aspect-square sm:aspect-[4/3]">
          {product.main_image_url ? (
            <img
              src={product.main_image_url}
              alt={product.name}
              loading="lazy"
              className="absolute inset-0 w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
            />
          ) : (
            <div className="absolute inset-0 w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-100 to-gray-50">
              <Package className="w-12 h-12 text-gray-300" />
            </div>
          )}
        </div>
        
        {/* Badges apilados */}
        <div className="absolute top-2 left-2 flex flex-col gap-1 z-10">
          {/* Badge de descuento */}
          {hasDiscount && (
            <span 
              className="px-2 py-1 text-xs font-bold text-white rounded-lg shadow-sm"
              style={{ backgroundColor: '#ef4444' }}
            >
              -{Math.round((1 - product.price / product.compare_price) * 100)}%
            </span>
          )}
          
          {/* Badge de variantes */}
          {hasVariants && activeVariants.length > 1 && (
            <span className="px-2 py-1 text-xs font-medium text-blue-700 bg-blue-100 rounded-lg">
              {activeVariants.length} opciones
            </span>
          )}
          
          {/* Badge de destacado */}
          {product.is_featured && (
            <span className="px-2 py-1 text-xs font-bold text-amber-700 bg-amber-100 rounded-lg flex items-center gap-1">
              <Star className="w-3 h-3 fill-amber-500 text-amber-500" />
              <span className="hidden sm:inline">Destacado</span>
            </span>
          )}
          
          {/* Badge de stock bajo */}
          {isLowStock && (
            <span className="px-2 py-1 text-xs font-medium text-orange-700 bg-orange-100 rounded-lg">
              춰칔ltimas {product.stock_quantity}!
            </span>
          )}
        </div>

        {/* Overlay en hover - Desktop */}
        <div className="absolute inset-0 bg-black/0 group-hover:bg-black/10 transition-colors hidden sm:block pointer-events-none" />
      </div>

      {/* Info */}
      <div className="p-3 sm:p-4">
        <h3 
          className="font-medium text-gray-900 text-sm leading-snug mb-1.5 line-clamp-2 cursor-pointer group-hover:text-gray-700 transition-colors"
          onClick={onView}
        >
          {product.name}
        </h3>
        
        {/* Precio - CON SOPORTE VARIANTES */}
        <div className="flex items-baseline gap-2 mb-3">
          {showPriceRange ? (
            <span className="font-bold text-gray-900 text-base">
              Desde {formatPrice(displayPrice)}
            </span>
          ) : (
            <>
              <span className="font-bold text-gray-900 text-base" style={{ color: hasDiscount ? '#ef4444' : 'inherit' }}>
                {formatPrice(displayPrice)}
              </span>
              {hasDiscount && (
                <span className="text-xs text-gray-400 line-through">
                  {formatPrice(product.compare_price)}
                </span>
              )}
            </>
          )}
        </div>

        {/* Bot칩n de agregar - Premium - CON SOPORTE VARIANTES */}
        <button
          onClick={handleAdd}
          disabled={isOutOfStock}
          className={`
            w-full py-2.5 text-sm font-semibold rounded-xl transition-all duration-200 flex items-center justify-center gap-2
            ${isOutOfStock 
              ? 'bg-gray-100 text-gray-400 cursor-not-allowed' 
              : added 
                ? 'bg-green-500 text-white' 
                : 'text-white hover:opacity-90 active:scale-[0.98]'
            }
          `}
          style={!isOutOfStock && !added ? { backgroundColor: primaryColor } : {}}
        >
          {isOutOfStock ? (
            'Agotado'
          ) : added ? (
            <>
              <Check className="w-4 h-4" />
              춰Agregado!
            </>
          ) : hasVariants && activeVariants.length > 1 ? (
            'Ver opciones'
          ) : (
            <>
              <Plus className="w-4 h-4" />
              Agregar
            </>
          )}
        </button>
      </div>
    </div>
  )
})

// Modal de detalle del producto - CON SOPORTE COMPLETO PARA VARIANTES
function ProductModal({ product, primaryColor, secondaryColor, formatPrice, imageIndex, setImageIndex, onClose, onAddToCart }) {
  // Estado para variantes
  const hasVariants = isProductWithVariants(product)
  const activeVariants = hasVariants ? getActiveVariants(product) : []
  const productOptions = hasVariants && Array.isArray(product.options) ? product.options : []
  
  // Estado de selecci칩n de opciones
  const [selectedOptions, setSelectedOptions] = useState(() => {
    // Inicializar con la primera opci칩n disponible de cada tipo si solo hay una variante
    if (hasVariants && activeVariants.length === 1) {
      return activeVariants[0].options || {}
    }
    return {}
  })
  
  // Encontrar variante seleccionada
  const selectedVariant = useMemo(() => {
    if (!hasVariants) return null
    return findMatchingVariant(activeVariants, selectedOptions)
  }, [hasVariants, activeVariants, selectedOptions])
  
  // Determinar precio a mostrar
  const displayPrice = selectedVariant?.price ?? (hasVariants ? getMinVariantPrice(product) : product.price)
  const showPriceRange = hasVariants && !selectedVariant && hasPriceRange(product)
  
  // Descuento (solo productos sin variantes)
  const hasDiscount = !hasVariants && product.compare_price && product.compare_price > product.price
  
  // Disponibilidad
  const isOutOfStock = hasVariants 
    ? (selectedVariant ? !getVariantAvailability(product, selectedVariant) : !getProductAvailability(product))
    : (product.track_inventory && product.stock_quantity === 0)
  
  // Stock disponible
  const availableStock = selectedVariant 
    ? getAvailableStock(product, selectedVariant)
    : getAvailableStock(product)
  
  // Validar si puede agregar al carrito
  const canAddToCart = hasVariants 
    ? (selectedVariant && !isOutOfStock)
    : !isOutOfStock
  
  // Galer칤a de im치genes (incluir imagen de variante si existe)
  const images = useMemo(() => {
    const baseImages = [
      product.main_image_url,
      ...(Array.isArray(product.gallery_urls) ? product.gallery_urls : [])
    ].filter(Boolean)
    
    // Si hay variante seleccionada con imagen, ponerla primero
    if (selectedVariant?.image_url && !baseImages.includes(selectedVariant.image_url)) {
      return [selectedVariant.image_url, ...baseImages]
    }
    
    return baseImages
  }, [product, selectedVariant])
  
  // Reset image index cuando cambia la variante
  useEffect(() => {
    if (selectedVariant?.image_url) {
      setImageIndex(0)
    }
  }, [selectedVariant, setImageIndex])
  
  // Manejar selecci칩n de opci칩n
  const handleOptionSelect = (optionName, value) => {
    setSelectedOptions(prev => ({
      ...prev,
      [optionName]: value
    }))
  }
  
  // Verificar si un valor est치 disponible
  const isValueAvailable = useCallback((optionName, value) => {
    // Crear opciones hipot칠ticas
    const testOptions = { ...selectedOptions, [optionName]: value }
    
    // Buscar si existe alguna variante activa con esas opciones (parciales)
    return activeVariants.some(variant => {
      const variantOptions = variant.options || {}
      // Verificar que todos los valores seleccionados coincidan
      return Object.entries(testOptions).every(([key, val]) => 
        variantOptions[key] === val || testOptions[key] === undefined
      )
    })
  }, [selectedOptions, activeVariants])
  
  // Manejar agregar al carrito
  const handleAddToCart = () => {
    if (!canAddToCart) return
    
    if (hasVariants) {
      onAddToCart(product, selectedVariant)
    } else {
      onAddToCart(product, null)
    }
    onClose()
  }

  return (
    <div className="fixed inset-0 z-50 flex items-end md:items-center justify-center">
      {/* Overlay */}
      <div 
        className="absolute inset-0 bg-black/60 backdrop-blur-sm"
        onClick={onClose}
      />

      {/* Modal */}
      <div className="relative w-full max-w-2xl max-h-[90vh] bg-white rounded-t-3xl md:rounded-3xl overflow-hidden animate-slide-up">
        {/* Cerrar */}
        <button
          onClick={onClose}
          className="absolute top-4 right-4 z-10 p-2 bg-white/90 backdrop-blur rounded-full shadow-lg hover:bg-white transition-colors"
        >
          <X className="w-5 h-5" />
        </button>

        <div className="flex flex-col md:flex-row max-h-[90vh] overflow-auto">
          {/* Imagen */}
          <div className="relative w-full md:w-1/2 aspect-square bg-gray-100 flex-shrink-0">
            {images.length > 0 ? (
              <>
                <img
                  src={images[imageIndex]}
                  alt={product.name}
                  className="w-full h-full object-cover"
                />
                {images.length > 1 && (
                  <>
                    <button
                      onClick={() => setImageIndex(i => i > 0 ? i - 1 : images.length - 1)}
                      className="absolute left-2 top-1/2 -translate-y-1/2 p-2 bg-white/90 rounded-full shadow-lg hover:bg-white"
                    >
                      <ChevronLeft className="w-5 h-5" />
                    </button>
                    <button
                      onClick={() => setImageIndex(i => i < images.length - 1 ? i + 1 : 0)}
                      className="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-white/90 rounded-full shadow-lg hover:bg-white"
                    >
                      <ChevronRight className="w-5 h-5" />
                    </button>
                    {/* Indicadores */}
                    <div className="absolute bottom-4 left-1/2 -translate-x-1/2 flex gap-1.5">
                      {images.map((_, i) => (
                        <button
                          key={i}
                          onClick={() => setImageIndex(i)}
                          className={`w-2 h-2 rounded-full transition-all ${
                            i === imageIndex ? 'w-6' : 'bg-white/50'
                          }`}
                          style={i === imageIndex ? { backgroundColor: primaryColor } : {}}
                        />
                      ))}
                    </div>
                  </>
                )}
              </>
            ) : (
              <div className="w-full h-full flex items-center justify-center">
                <Package className="w-20 h-20 text-gray-300" />
              </div>
            )}
          </div>

          {/* Detalles */}
          <div className="flex-1 p-6 flex flex-col">
            <h2 className="text-xl font-bold text-gray-900 mb-2">{product.name}</h2>
            
            {/* Precio - CON SOPORTE VARIANTES */}
            <div className="flex items-center gap-3 mb-4">
              {showPriceRange ? (
                <span className="text-2xl font-bold" style={{ color: primaryColor }}>
                  Desde {formatPrice(displayPrice)}
                </span>
              ) : (
                <>
                  <span className="text-2xl font-bold" style={{ color: primaryColor }}>
                    {formatPrice(displayPrice)}
                  </span>
                  {hasDiscount && (
                    <>
                      <span className="text-lg text-gray-400 line-through">
                        {formatPrice(product.compare_price)}
                      </span>
                      <span 
                        className="px-2 py-0.5 text-xs font-bold text-white rounded-md"
                        style={{ backgroundColor: secondaryColor }}
                      >
                        -{Math.round((1 - product.price / product.compare_price) * 100)}%
                      </span>
                    </>
                  )}
                </>
              )}
            </div>
            
            {/* Variante seleccionada */}
            {hasVariants && selectedVariant && (
              <p className="text-sm text-gray-600 mb-4">
                <span className="font-medium">Seleccionado:</span> {selectedVariant.title}
              </p>
            )}

            {/* Descripci칩n */}
            {product.description && (
              <div className="mb-4">
                <p className="text-gray-600 leading-relaxed text-sm">{product.description}</p>
              </div>
            )}
            
            {/* ====== SELECTOR DE VARIANTES ====== */}
            {hasVariants && productOptions.length > 0 && (
              <div className="space-y-4 mb-4">
                {productOptions.map((option) => (
                  <div key={option.name}>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      {option.name}
                      {!selectedOptions[option.name] && (
                        <span className="text-red-500 ml-1">*</span>
                      )}
                    </label>
                    <div className="flex flex-wrap gap-2">
                      {option.values.map((value) => {
                        const isSelected = selectedOptions[option.name] === value
                        const isAvailable = isValueAvailable(option.name, value)
                        
                        return (
                          <button
                            key={value}
                            type="button"
                            onClick={() => handleOptionSelect(option.name, value)}
                            disabled={!isAvailable}
                            className={`
                              px-4 py-2 text-sm font-medium rounded-xl border-2 transition-all
                              ${isSelected 
                                ? 'text-white shadow-md' 
                                : isAvailable
                                  ? 'bg-white text-gray-700 border-gray-200 hover:border-gray-300'
                                  : 'bg-gray-50 text-gray-300 border-gray-100 cursor-not-allowed line-through'
                              }
                            `}
                            style={isSelected ? { 
                              backgroundColor: primaryColor, 
                              borderColor: primaryColor 
                            } : {}}
                          >
                            {value}
                          </button>
                        )
                      })}
                    </div>
                  </div>
                ))}
                
                {/* Indicador de selecci칩n requerida */}
                {hasVariants && !selectedVariant && (
                  <p className="text-sm text-amber-600 flex items-center gap-1">
                    <AlertCircle className="w-4 h-4" />
                    Selecciona una opci칩n para continuar
                  </p>
                )}
              </div>
            )}

            {/* Stock (si aplica) */}
            {product.track_inventory && (
              <p className={`text-sm mb-4 ${availableStock > 0 ? 'text-green-600' : 'text-red-500'}`}>
                {availableStock > 0 
                  ? availableStock === Infinity 
                    ? 'Disponible' 
                    : `${availableStock} disponibles`
                  : 'Agotado'}
              </p>
            )}

            {/* Espacio flexible */}
            <div className="flex-1" />

            {/* Bot칩n agregar */}
            <button
              onClick={handleAddToCart}
              disabled={!canAddToCart}
              className="w-full py-4 text-white font-semibold rounded-2xl transition-all hover:opacity-90 active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed"
              style={{ backgroundColor: canAddToCart ? primaryColor : '#9ca3af' }}
            >
              {isOutOfStock ? 'Agotado' : hasVariants && !selectedVariant ? 'Selecciona una opci칩n' : 'Agregar al carrito'}
            </button>
          </div>
        </div>
      </div>

      <style>{`
        @keyframes slide-up {
          from { transform: translateY(100%); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }
        .animate-slide-up {
          animation: slide-up 0.3s ease-out;
        }
      `}</style>
    </div>
  )
}

// Drawer del carrito - CON SOPORTE VARIANTES
function CartDrawer({ cart, store, primaryColor, formatPrice, cartTotal, updateQuantity, removeFromCart, onClose, onCheckout }) {
  return (
    <div className="fixed inset-0 z-50 flex justify-end">
      {/* Overlay */}
      <div 
        className="absolute inset-0 bg-black/60 backdrop-blur-sm"
        onClick={onClose}
      />

      {/* Drawer */}
      <div className="relative w-full max-w-md h-full bg-white shadow-2xl animate-slide-left flex flex-col">
        {/* Header */}
        <div className="flex items-center justify-between p-4 border-b border-gray-100">
          <h2 className="text-lg font-bold text-gray-900">Tu carrito</h2>
          <button
            onClick={onClose}
            className="p-2 hover:bg-gray-100 rounded-xl transition-colors"
          >
            <X className="w-5 h-5" />
          </button>
        </div>

        {/* Items */}
        <div className="flex-1 overflow-auto p-4">
          {cart.length === 0 ? (
            <div className="h-full flex flex-col items-center justify-center text-center">
              <ShoppingBag className="w-16 h-16 text-gray-300 mb-4" />
              <p className="text-gray-500">Tu carrito est치 vac칤o</p>
            </div>
          ) : (
            <div className="space-y-4">
              {cart.map(item => (
                <div key={item.cartItemId} className="flex gap-3 p-3 bg-gray-50 rounded-xl">
                  {/* Imagen */}
                  <div className="w-16 h-16 bg-gray-200 rounded-lg overflow-hidden flex-shrink-0">
                    {item.main_image_url ? (
                      <img 
                        src={item.main_image_url} 
                        alt={item.name}
                        className="w-full h-full object-cover"
                      />
                    ) : (
                      <div className="w-full h-full flex items-center justify-center">
                        <Package className="w-6 h-6 text-gray-400" />
                      </div>
                    )}
                  </div>

                  {/* Info */}
                  <div className="flex-1 min-w-0">
                    <h4 className="font-medium text-gray-900 text-sm truncate">{item.name}</h4>
                    {/* Mostrar variante si existe */}
                    {item.variant_title && (
                      <p className="text-xs text-gray-500 truncate">{item.variant_title}</p>
                    )}
                    <p className="text-sm font-bold" style={{ color: primaryColor }}>
                      {formatPrice(item.price)}
                    </p>
                    
                    {/* Controles de cantidad */}
                    <div className="flex items-center gap-2 mt-2">
                      <button
                        onClick={() => updateQuantity(item.cartItemId, -1)}
                        className="w-7 h-7 flex items-center justify-center rounded-lg bg-white border border-gray-200 hover:bg-gray-100"
                      >
                        <Minus className="w-3 h-3" />
                      </button>
                      <span className="w-8 text-center font-medium text-sm">{item.quantity}</span>
                      <button
                        onClick={() => updateQuantity(item.cartItemId, 1)}
                        className="w-7 h-7 flex items-center justify-center rounded-lg bg-white border border-gray-200 hover:bg-gray-100"
                      >
                        <Plus className="w-3 h-3" />
                      </button>
                    </div>
                  </div>

                  {/* Subtotal y eliminar */}
                  <div className="flex flex-col items-end justify-between">
                    <button
                      onClick={() => removeFromCart(item.cartItemId)}
                      className="p-1 hover:bg-red-100 rounded text-gray-400 hover:text-red-500"
                    >
                      <Trash2 className="w-4 h-4" />
                    </button>
                    <span className="text-sm font-bold text-gray-900">
                      {formatPrice(item.price * item.quantity)}
                    </span>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>

        {/* Footer con total y bot칩n */}
        {cart.length > 0 && (
          <div className="border-t border-gray-100 p-4 space-y-4">
            {/* Total */}
            <div className="flex items-center justify-between">
              <span className="text-gray-600">Total</span>
              <span className="text-2xl font-bold text-gray-900">{formatPrice(cartTotal)}</span>
            </div>

            {/* Bot칩n WhatsApp */}
            <button
              onClick={onCheckout}
              className="w-full py-4 flex items-center justify-center gap-3 text-white font-semibold rounded-2xl transition-all hover:opacity-90 active:scale-[0.98]"
              style={{ backgroundColor: '#25D366' }}
            >
              <MessageCircle className="w-5 h-5" />
              Finalizar pedido por WhatsApp
            </button>
          </div>
        )}
      </div>

      <style>{`
        @keyframes slide-left {
          from { transform: translateX(100%); }
          to { transform: translateX(0); }
        }
        .animate-slide-left {
          animation: slide-left 0.3s ease-out;
        }
      `}</style>
    </div>
  )
}

// ============================================
// SECCI칍N "TE PUEDE INTERESAR" (Premium)
// ============================================

function RecommendedSection({ products, primaryColor, formatPrice, onView, onAddToCart }) {
  if (!products || products.length === 0) return null

  return (
    <section className="mt-12 pt-8 border-t border-gray-200">
      {/* Header de la secci칩n */}
      <div className="flex items-center gap-3 mb-6">
        <div 
          className="p-2 rounded-xl"
          style={{ backgroundColor: `${primaryColor}15` }}
        >
          <Sparkles className="w-5 h-5" style={{ color: primaryColor }} />
        </div>
        <div>
          <h2 className="text-lg font-bold text-gray-900">Te puede interesar</h2>
          <p className="text-sm text-gray-500">Basado en lo que has visto</p>
        </div>
      </div>

      {/* Grid de productos - M치ximo 4 sugerencias */}
      <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
        {products.slice(0, 4).map(product => (
          <ProductCard
            key={product.id}
            product={product}
            primaryColor={primaryColor}
            formatPrice={formatPrice}
            onView={() => onView(product)}
            onAddToCart={(p, v) => onAddToCart(p || product, v)}
          />
        ))}
      </div>
    </section>
  )
}

// ============================================
// FOOTER DE TIENDA - Informaci칩n adicional
// ============================================

function StoreFooter({ store, primaryColor }) {
  const hasContactInfo = store.address || store.business_hours || store.whatsapp
  const hasSocialLinks = store.social_links && Object.keys(store.social_links).length > 0
  const hasPaymentMethods = store.payment_methods && store.payment_methods.length > 0
  const hasDeliveryInfo = store.delivery_info
  
  // Si no hay info adicional, no renderizar
  if (!hasContactInfo && !hasSocialLinks && !hasPaymentMethods && !hasDeliveryInfo) {
    return null
  }

  // Parsear business_hours si es JSONB
  const businessHoursText = typeof store.business_hours === 'object' 
    ? store.business_hours?.text 
    : store.business_hours

  return (
    <footer className="mt-12 pt-8">
      <div className="bg-white rounded-2xl border border-gray-100 shadow-sm overflow-hidden">
        {/* Header */}
        <div className="px-5 sm:px-6 pt-5 sm:pt-6 pb-4 border-b border-gray-100">
          <div className="flex items-center gap-3">
            <div 
              className="w-10 h-10 rounded-xl flex items-center justify-center"
              style={{ backgroundColor: `${primaryColor}15` }}
            >
              <Store className="w-5 h-5" style={{ color: primaryColor }} />
            </div>
            <div>
              <h3 className="text-base sm:text-lg font-semibold text-gray-900">
                Informaci칩n
              </h3>
              <p className="text-xs sm:text-sm text-gray-500">
                Contacta y conoce m치s sobre esta tienda
              </p>
            </div>
          </div>
        </div>

        {/* Content Grid */}
        <div className="p-5 sm:p-6">
          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            
            {/* Bloque: Contacto */}
            {(store.whatsapp || store.address || store.city) && (
              <div className="bg-gray-50/50 rounded-xl border border-gray-100 p-4">
                <div className="flex items-center gap-2 mb-3">
                  <span className="text-xs uppercase tracking-wide font-medium text-gray-500">
                    Contacto
                  </span>
                </div>
                
                <div className="space-y-3">
                  {/* Ubicaci칩n */}
                  {(store.address || store.city) && (
                    <div className="flex items-start gap-3">
                      <div className="p-2 rounded-lg bg-white border border-gray-100 shrink-0">
                        <MapPin className="w-4 h-4 text-gray-500" />
                      </div>
                      <div className="min-w-0">
                        <p className="text-xs text-gray-500">Ubicaci칩n</p>
                        <p className="text-sm font-medium text-gray-900 truncate">
                          {[store.address, store.city].filter(Boolean).join(', ')}
                        </p>
                      </div>
                    </div>
                  )}

                  {/* Horario */}
                  {businessHoursText && (
                    <div className="flex items-start gap-3">
                      <div className="p-2 rounded-lg bg-white border border-gray-100 shrink-0">
                        <Clock className="w-4 h-4 text-gray-500" />
                      </div>
                      <div className="min-w-0">
                        <p className="text-xs text-gray-500">Horario</p>
                        <p className="text-sm font-medium text-gray-900">
                          {businessHoursText}
                        </p>
                      </div>
                    </div>
                  )}

                  {/* WhatsApp con CTA */}
                  {store.whatsapp && (
                    <div className="pt-2">
                      <a 
                        href={`https://wa.me/${store.whatsapp.replace(/\D/g, '')}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="flex items-center justify-center gap-2 w-full py-2.5 px-4 rounded-xl font-medium text-sm text-white transition-all hover:opacity-90 active:scale-[0.98]"
                        style={{ backgroundColor: '#25D366' }}
                      >
                        <Phone className="w-4 h-4" />
                        Escribir por WhatsApp
                      </a>
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* Bloque: Redes Sociales */}
            {hasSocialLinks && (
              <div className="bg-gray-50/50 rounded-xl border border-gray-100 p-4">
                <div className="flex items-center gap-2 mb-3">
                  <span className="text-xs uppercase tracking-wide font-medium text-gray-500">
                    S칤guenos
                  </span>
                </div>
                
                <div className="flex flex-wrap gap-2">
                  {store.social_links.instagram && (
                    <a
                      href={`https://instagram.com/${store.social_links.instagram.replace('@', '')}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex items-center gap-2 px-4 py-2.5 bg-white border border-gray-200 rounded-xl hover:bg-gray-50 hover:border-gray-300 transition-all group"
                    >
                      <div className="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 via-pink-500 to-orange-400 flex items-center justify-center">
                        <Instagram className="w-4 h-4 text-white" />
                      </div>
                      <div className="text-left">
                        <p className="text-xs text-gray-500">Instagram</p>
                        <p className="text-sm font-medium text-gray-900 group-hover:text-gray-700">
                          @{store.social_links.instagram.replace('@', '')}
                        </p>
                      </div>
                    </a>
                  )}
                  
                  {store.social_links.facebook && (
                    <a
                      href={store.social_links.facebook.startsWith('http') 
                        ? store.social_links.facebook 
                        : `https://facebook.com/${store.social_links.facebook}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex items-center gap-2 px-4 py-2.5 bg-white border border-gray-200 rounded-xl hover:bg-gray-50 hover:border-gray-300 transition-all group"
                    >
                      <div className="w-8 h-8 rounded-lg bg-blue-600 flex items-center justify-center">
                        <Facebook className="w-4 h-4 text-white" />
                      </div>
                      <div className="text-left">
                        <p className="text-xs text-gray-500">Facebook</p>
                        <p className="text-sm font-medium text-gray-900 group-hover:text-gray-700">
                          Visitar p치gina
                        </p>
                      </div>
                    </a>
                  )}

                  {store.social_links.tiktok && (
                    <a
                      href={`https://tiktok.com/@${store.social_links.tiktok.replace('@', '')}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="flex items-center gap-2 px-4 py-2.5 bg-white border border-gray-200 rounded-xl hover:bg-gray-50 hover:border-gray-300 transition-all group"
                    >
                      <div className="w-8 h-8 rounded-lg bg-black flex items-center justify-center">
                        <svg className="w-4 h-4 text-white" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M19.59 6.69a4.83 4.83 0 01-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 01-5.2 1.74 2.89 2.89 0 012.31-4.64 2.93 2.93 0 01.88.13V9.4a6.84 6.84 0 00-1-.05A6.33 6.33 0 005 20.1a6.34 6.34 0 0010.86-4.43v-7a8.16 8.16 0 004.77 1.52v-3.4a4.85 4.85 0 01-1-.1z"/>
                        </svg>
                      </div>
                      <div className="text-left">
                        <p className="text-xs text-gray-500">TikTok</p>
                        <p className="text-sm font-medium text-gray-900 group-hover:text-gray-700">
                          @{store.social_links.tiktok.replace('@', '')}
                        </p>
                      </div>
                    </a>
                  )}
                </div>
              </div>
            )}

            {/* Bloque: M칠todos de Pago y Env칤o */}
            {(hasPaymentMethods || hasDeliveryInfo) && (
              <div className="bg-gray-50/50 rounded-xl border border-gray-100 p-4">
                {hasPaymentMethods && (
                  <div className="mb-4">
                    <div className="flex items-center gap-2 mb-3">
                      <CreditCard className="w-4 h-4 text-gray-400" />
                      <span className="text-xs uppercase tracking-wide font-medium text-gray-500">
                        M칠todos de pago
                      </span>
                    </div>
                    <div className="flex flex-wrap gap-2">
                      {store.payment_methods.map((method, idx) => (
                        <span 
                          key={idx}
                          className="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-medium bg-white border border-gray-200 text-gray-700"
                        >
                          {method}
                        </span>
                      ))}
                    </div>
                  </div>
                )}

                {hasDeliveryInfo && (
                  <div>
                    <div className="flex items-center gap-2 mb-3">
                      <Truck className="w-4 h-4 text-gray-400" />
                      <span className="text-xs uppercase tracking-wide font-medium text-gray-500">
                        Env칤os
                      </span>
                    </div>
                    <p className="text-sm font-medium text-gray-900">
                      {store.delivery_info}
                    </p>
                  </div>
                )}
              </div>
            )}
          </div>
        </div>

        {/* Powered by EmprendeGo (todos los planes excepto PRO) */}
        {store.plan !== 'pro' && (
          <div className="px-5 sm:px-6 py-5 border-t border-gray-100 bg-gradient-to-b from-gray-50/50 to-white">
            <div className="flex flex-col sm:flex-row items-center justify-center gap-3 sm:gap-4">
              {/* Logo + Texto */}
              <div className="flex items-center gap-2 text-gray-500">
                <div 
                  className="w-5 h-5 rounded-md flex items-center justify-center text-white text-[10px] font-bold"
                  style={{ background: `linear-gradient(135deg, ${primaryColor}, ${primaryColor}dd)` }}
                >
                  E
                </div>
                <span className="text-xs sm:text-sm">
                  Creado con{' '}
                  <a 
                    href="/" 
                    target="_blank" 
                    rel="noopener noreferrer"
                    className="font-semibold hover:underline transition-colors"
                    style={{ color: primaryColor }}
                  >
                    EmprendeGo
                  </a>
                </span>
              </div>
              
              {/* Separador visual (solo desktop) */}
              <span className="hidden sm:block w-1 h-1 rounded-full bg-gray-300" />
              
              {/* CTA */}
              <a
                href="/vende-con-nosotros"
                target="_blank"
                rel="noopener noreferrer"
                className="inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full border border-gray-200 bg-white hover:bg-gray-50 hover:border-gray-300 text-xs font-medium text-gray-600 hover:text-gray-900 transition-all"
              >
                <Rocket className="w-3 h-3" />
                Vende con nosotros
              </a>
            </div>
          </div>
        )}
      </div>
    </footer>
  )
}
